<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head>
    <title>B√°o c√°o | Gym Health Monitor</title>

    <th:block th:replace="base :: head"></th:block>
</head>

<body>
    <div th:replace="base :: header"></div>
    <div th:replace="base :: message"></div>

    <main class="container mt-3">
        <h2 class="text-center mb-3 w-100">üìà B√°o c√°o</h2>
        
        <div class="filter-container mb-3">
            <label for="fromDate">T·ª´ ng√†y:</label>
            <input type="date" id="fromDate">

            <label for="toDate">ƒê·∫øn ng√†y:</label>
            <input type="date" id="toDate">

            <button class="btn btn-success" onclick="loadRevenueChart()">L·ªçc</button>
        </div>
        
        <canvas id="chart" class="mb-4"></canvas>
        
    </main>

    <div th:replace="base :: footer"></div>

    <script th:inline="javascript">
        let chartInstance;

        async function loadRevenueChart() {
            const fromDate = document.getElementById("fromDate").value;
            const toDate = document.getElementById("toDate").value;

            const url = new URL([[@{/stats/revenue}]], window.location.origin);
            if (fromDate) url.searchParams.append("fromDate", fromDate);
            if (toDate) url.searchParams.append("toDate", toDate);

            try {
                const response = await fetch(url);
                const data = await response.json();

                const ctx = document.getElementById('chart').getContext('2d');

                // Destroy chart c≈© n·∫øu ƒë√£ c√≥
                if (chartInstance) chartInstance.destroy();

                // T·∫°o gradient m√†u n·ªÅn
                const gradient = ctx.createLinearGradient(0, 0, 0, 400);
                gradient.addColorStop(0, '#42a5f5'); // xanh nh·∫°t
                gradient.addColorStop(1, '#1e88e5'); // xanh ƒë·∫≠m

                chartInstance = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: data.labels,
                        datasets: [{
                            label: 'T·ªïng doanh thu (VNƒê)',
                            data: data.values,
                            backgroundColor: gradient,
                            borderRadius: 5,
                            borderSkipped: false
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            tooltip: {
                                callbacks: {
                                    label: function (context) {
                                        let value = context.parsed.y;
                                        return ' ' + value.toLocaleString('vi-VN') + ' ‚Ç´';
                                    }
                                }
                            },
                            legend: {
                                display: true,
                                labels: {
                                    color: '#333',
                                    font: {
                                        size: 14
                                    }
                                }
                            },
                            title: {
                                display: true,
                                text: 'Bi·ªÉu ƒë·ªì doanh thu theo ng√†y',
                                font: {
                                    size: 18
                                }
                            }
                        },
                        scales: {
                            y: {
                                ticks: {
                                    callback: function (value) {
                                        return value.toLocaleString('vi-VN') + ' ‚Ç´';
                                    }
                                },
                                title: {
                                    display: true,
                                    text: 'Doanh thu (VNƒê)'
                                },
                                beginAtZero: true
                            },
                            x: {
                                title: {
                                    display: true,
                                    text: 'Ng√†y'
                                }
                            }
                        }
                    }
                });

            } catch (err) {
                console.error(err);
                showMessage('danger', 'Kh√¥ng th·ªÉ t·∫£i bi·ªÉu ƒë·ªì. Vui l√≤ng th·ª≠ l·∫°i sau.!');
            }
        }

        window.onload = loadRevenueChart;
    </script>
</body>

</html>